---
title: 'redeem Function'
weight: 3
---

# Redeeming Locks

## Function Signature

```solidity
function redeem(uint256 tokenId) public
```

### Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `tokenId` | `uint256` | The ERC721 token ID representing your lock position |

## TokenLock Data Structure

```solidity
struct TokenLock {
    uint256 initiativeId;     // Which initiative this supports
    uint256 tokenAmount;      // Underlying tokens locked
    uint256 lockDuration;     // Duration in intervals
    uint256 created;          // Block timestamp of creation
    bool withdrawn;           // Redemption status
}
```

## Checking Redemption Status

```solidity
// Get initiative details
Initiative memory init = signals.getInitiative(initiativeId)

// Check if redeemable
bool isRedeemable = (init.state == InitiativeState.Accepted ||
                     init.state == InitiativeState.Expired)

// For accepted initiatives, check if timelock has passed
if (init.state == InitiativeState.Accepted) {
    uint256 releaseTime = init.acceptanceTimestamp + releaseLockDuration
    bool canRedeemNow = block.timestamp >= releaseTime
}
```

## Finding Your Token IDs

```solidity
// Get all your lock positions
uint256[] memory tokenIds = signals.listPositions(yourAddress)

// Or get locks for specific supporter
uint256[] memory tokenIds = signals.getLocksForSupporter(yourAddress)
```

## Example Redemption Flow

```solidity
// 1. Find your positions
uint256[] memory myTokenIds = signals.listPositions(msg.sender)

// 2. For each token, check if redeemable
for (uint256 i = 0; i < myTokenIds.length; i++) {
    uint256 tokenId = myTokenIds[i]

    // Get lock details
    TokenLock memory lock = signals.getTokenLock(tokenId)

    // Skip if already withdrawn
    if (lock.withdrawn) continue

    // Get initiative
    Initiative memory init = signals.getInitiative(lock.initiativeId)

    // Check if redeemable
    if (init.state == InitiativeState.Accepted) {
        uint256 releaseTime = init.acceptanceTimestamp + signals.releaseLockDuration()
        if (block.timestamp >= releaseTime) {
            // Redeem
            signals.redeem(tokenId)
        }
    } else if (init.state == InitiativeState.Expired) {
        // Redeem immediately
        signals.redeem(tokenId)
    }
}
```

## Validation & Errors

| Error | Condition | Solution |
|-------|-----------|----------|
| `Signals_AlreadyRedeemed` | Position already redeemed | Check `lock.withdrawn` status |
| `Signals_NotTokenOwner` | You don't own the NFT | Verify NFT ownership |
| `Signals_NotWithdrawableState` | Initiative still Proposed | Wait for acceptance or expiration |
| `Signals_StillTimelocked` | Release timelock not passed | Wait until `acceptanceTimestamp + releaseLockDuration` |

## Frontend Integration

```typescript
// Check if user can redeem
async function canRedeem(tokenId: bigint) {
  // Get lock details
  const lock = await signals.read.getTokenLock([tokenId])

  // Already withdrawn?
  if (lock.withdrawn) return false

  // Get initiative
  const initiative = await signals.read.getInitiative([lock.initiativeId])

  // Check state
  if (initiative.state === 0) return false  // 0 = Proposed

  if (initiative.state === 1) {  // 1 = Accepted
    const releaseLockDuration = await signals.read.releaseLockDuration()
    const releaseTime = initiative.acceptanceTimestamp + releaseLockDuration
    return BigInt(Date.now() / 1000) >= releaseTime
  }

  if (initiative.state === 3) {  // 3 = Expired
    return true  // Immediate redemption
  }

  return false
}

// Redeem position
async function redeemPosition(tokenId: bigint) {
  const tx = await signals.write.redeem([tokenId])
  await tx.wait()
  console.log(`Redeemed token ${tokenId}`)
}
```

## Related Functions

```solidity
// Query functions
function getTokenLock(uint256 tokenId) external view returns (TokenLock memory)
function getInitiative(uint256 initiativeId) external view returns (Initiative memory)
function listPositions(address owner) external view returns (uint256[] memory)
function releaseLockDuration() external view returns (uint256)

// Redemption
function redeem(uint256 tokenId) public
```
